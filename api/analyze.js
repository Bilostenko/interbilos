import OpenAI from "openai";
const openai = new OpenAI();

export default async function handler(req, res) {
  if (req.method !== "POST") {
    return res.status(405).json({ error: "Method not allowed" });
  }

  const { text } = req.body;

  try {
    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        {
          role: "system",
          content: `
–¢–∏ –ø–æ–º—ñ—á–Ω–∏–∫, —è–∫–∏–π —Ä–æ–±–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∏–π —Å—Ç–∏—Å–ª–∏–π –ø–µ—Ä–µ–∫–∞–∑ –æ—Ñ—ñ—Ü—ñ–π–Ω–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é.
–¢–∏ –º–∞—î—à –ø–æ–≤–µ—Ä—Ç–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –¢–Ü–õ–¨–ö–ò —É —Ñ–æ—Ä–º–∞—Ç—ñ –≤–∞–ª—ñ–¥–Ω–æ–≥–æ JSON –∑ —Ç–∞–∫–∏–º–∏ –ø–æ–ª—è–º–∏:
{
  "date": "...",
  "sender": "...",
  "reference": "...",
  "subject": "...",
  "items": "...",
  "summary": "...",
  "checks": [
    "...",
    "..."
  ]
}

–ü–æ—è—Å–Ω–µ–Ω–Ω—è:
- "date": –ó–Ω–∞–π–¥–∏ —Ä—è–¥–æ–∫, —â–æ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑—ñ —Å–ª–æ–≤–∞ "Date:" —ñ –≤–∏—Ç—è–≥–Ω–∏ –¥–∞—Ç—É –ø—ñ—Å–ª—è –¥–≤–æ–∫—Ä–∞–ø–∫–∏ —É —Ñ–æ—Ä–º–∞—Ç—ñ –î–î/–ú–ú/–†–†–†–†.
  –Ø–∫—â–æ —Ç–∞–∫–æ–≥–æ —Ä—è–¥–∫–∞ –Ω–µ–º–∞—î, –ø–æ–≤–µ—Ä–Ω–∏ "UNKNOWN".

- "sender": –°–ø–æ—á–∞—Ç–∫—É –∑–Ω–∞–π–¥–∏ —Ä—è–¥–æ–∫, —â–æ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑—ñ —Å–ª—ñ–≤ "NCB" –∞–±–æ "INTERPOL" —ñ –º—ñ—Å—Ç–∏—Ç—å –Ω–∞–∑–≤—É –º—ñ—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "INTERPOL BUDAPEST").
  –Ø–∫—â–æ —Ç–∞–∫–∏–π —Ä—è–¥–æ–∫ —î, –≤–∏—Ç—è–≥–Ω–∏ –Ω–∞–∑–≤—É –º—ñ—Å—Ç–∞ –≤–µ–ª–∏–∫–∏–º–∏ –ª—ñ—Ç–µ—Ä–∞–º–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "BUDAPEST").
  –Ø–∫—â–æ —Ç–∞–∫–æ–≥–æ —Ä—è–¥–∫–∞ –Ω–µ–º–∞—î, –∞–ª–µ —É —Ç–µ–∫—Å—Ç—ñ —î –Ω–∞–∑–≤–∞ –∫—Ä–∞—ó–Ω–∏, –ø–µ—Ä–µ—Ç–≤–æ—Ä–∏ –Ω–∞–∑–≤—É –∫—Ä–∞—ó–Ω–∏ –Ω–∞ –Ω–∞–∑–≤—É —ó—ó —Å—Ç–æ–ª–∏—Ü—ñ –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é –≤–µ–ª–∏–∫–∏–º–∏ –ª—ñ—Ç–µ—Ä–∞–º–∏.
  –ù–∞–ø—Ä–∏–∫–ª–∞–¥:
    Hungary ‚Üí BUDAPEST
    Germany ‚Üí BERLIN
    France ‚Üí PARIS
  –Ø–∫—â–æ –∫—Ä–∞—ó–Ω–∞ —ñ–Ω—à–∞, –Ω–∞–ø–∏—à–∏ –Ω–∞–∑–≤—É —ó—ó —Å—Ç–æ–ª–∏—Ü—ñ –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é –≤–µ–ª–∏–∫–∏–º–∏ –ª—ñ—Ç–µ—Ä–∞–º–∏.
  –Ø–∫—â–æ –Ω—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, –ø–æ–≤–µ—Ä–Ω–∏ "UNKNOWN".

- "reference": —Ä–µ—Ñ–µ—Ä–µ–Ω—Å —Å–ø—Ä–∞–≤–∏ (—â–æ –π–¥–µ –ø—ñ—Å–ª—è —Å–ª–æ–≤–∞ Ref).

- "subject": —Ç–µ–º–∞ –∑–∞–ø–∏—Ç—É.

- "items": –Ü–º–µ–Ω–∞ –∞–±–æ –ø—Ä–µ–¥–º–µ—Ç–∏ –∑–∞–ø–∏—Ç—É (–ª–∏—à–µ —Ç—ñ –æ—Å–æ–±–∏ —á–∏ –ø—Ä–µ–¥–º–µ—Ç–∏, —â–æ–¥–æ —è–∫–∏—Ö –ø—Ä—è–º–æ –∞–±–æ –ø–æ–±—ñ—á–Ω–æ –∑–∞–ø–∏—Ç—É—î—Ç—å—Å—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è —á–∏ –≤–∂–∏–≤–∞—é—Ç—å—Å—è –∑–∞—Ö–æ–¥–∏).
  –í–ê–ñ–õ–ò–í–û: —è–∫—â–æ —î –¥–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è, –≤–æ–Ω–∞ –º–∞—î —Å—Ç–æ—è—Ç–∏ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –ø—ñ—Å–ª—è —ñ–º–µ–Ω—ñ —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–∞, —á–µ—Ä–µ–∑ –∫–æ–º—É. –ù–∞–ø—Ä–∏–∫–ª–∞–¥: "–°–µ—Ä–≥—ñ–π –£–∑—É–Ω, 14.04.1978". –õ–∏—à–µ –ø–æ—Ç—ñ–º (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ) —ñ–Ω—à—ñ –¥–∞–Ω—ñ (–≥—Ä–æ–º–∞–¥—è–Ω—Å—Ç–≤–æ —Ç–æ—â–æ).

- "summary": –∫–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å –∑–º—ñ—Å—Ç—É –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–∫–æ–Ω—Ç–µ–∫—Å—Ç, —Ö—Ç–æ –∫–æ–≥–æ –∑–≥–∞–¥—É—î, —â–æ —Å—Ç–∞–ª–æ—Å—è).
  –Ø–∫—â–æ –≤ –¥–æ–∫—É–º–µ–Ω—Ç—ñ —î –∞–¥—Ä–µ—Å–∞ (–º—ñ—Å—Ü–µ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è, –∞–¥—Ä–µ—Å–∞ –∫–æ–º–ø–∞–Ω—ñ—ó, –∞–¥—Ä–µ—Å–∞ –∑–ª–æ—á–∏–Ω—É —Ç–æ—â–æ) ‚Äî –û–ë–û–í‚Äô–Ø–ó–ö–û–í–û –≤—ñ–¥–æ–±—Ä–∞–∑–∏ —ó—ó –≤ —Ü—å–æ–º—É –ø–æ–ª—ñ.

- "checks": —á—ñ—Ç–∫–æ –ø–æ –ø—É–Ω–∫—Ç–∞—Ö, —â–æ –∑–∞–ø–∏—Ç—É—é—Ç—å –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∞–±–æ –Ω–∞–¥–∞—Ç–∏.

üìå –Ø–∫—â–æ –≤ —Ç–µ–∫—Å—Ç—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∑–≥–∞–¥—É—î—Ç—å—Å—è, —â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∞–±–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ —è–∫—É—Å—å —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é (–Ω–∞–≤—ñ—Ç—å —è–∫—â–æ —Ü–µ –ø–æ–¥–∞–Ω–æ —É –≤–∏–≥–ª—è–¥—ñ –≥–æ—Ç–æ–≤–æ–≥–æ —Å–ø–∏—Å–∫—É –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é –º–æ–≤–æ—é), —Ç–∏ –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ –º–∞—î—à:

1. –ü–µ—Ä–µ–∫–ª–∞—Å—Ç–∏ —É—Å—ñ —Ü—ñ –ø–∏—Ç–∞–Ω–Ω—è –∞–±–æ –ø—É–Ω–∫—Ç–∏ –Ω–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫—É –º–æ–≤—É.
2. –ó–∞–ø–∏—Å–∞—Ç–∏ —ó—Ö —è–∫ –æ–∫—Ä–µ–º—ñ —Ä—è–¥–∫–∏ —É –º–∞—Å–∏–≤—ñ "checks".
3. –§–æ—Ä–º—É–ª—é–π –∫–æ–∂–µ–Ω –ø—É–Ω–∫—Ç –∫–æ—Ä–æ—Ç–∫–æ —Ç–∞ —Å–ª—É–∂–±–æ–≤–æ, –±–µ–∑ –≤–æ–¥–∏.
4. –ù–∞–≤—ñ—Ç—å —è–∫—â–æ –ø–∏—Ç–∞–Ω–Ω—è –æ—Ñ–æ—Ä–º–ª–µ–Ω—ñ —è–∫ —Å–ø–∏—Å–æ–∫ —Ç–∏–ø—É:
   - Is he known to your law enforcement authorities?
   - Did he apply for a passport?
   –¢–∏ –≤—Å–µ –æ–¥–Ω–æ –∑–æ–±–æ–≤‚Äô—è–∑–∞–Ω–∏–π –ø–µ—Ä–µ–∫–ª–∞—Å—Ç–∏ —ó—Ö —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é —ñ –≤—Å—Ç–∞–≤–∏—Ç–∏ —É –º–∞—Å–∏–≤ "checks".

–Ø–∫—â–æ —è–∫–æ—ó—Å—å —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –Ω–µ–º–∞—î, –ø–∏—à–∏ "–ù–µ–º–∞—î".
–ù–ï –¥–æ–¥–∞–≤–∞–π –Ω—ñ—á–æ–≥–æ –ø–æ–∑–∞ JSON.
`.trim(),
        },
        {
          role: "user",
          content: `–ó—Ä–æ–±–∏ —Å—Ç–∏—Å–ª–∏–π –ø–µ—Ä–µ–∫–∞–∑ —Ü—å–æ–≥–æ —Ç–µ–∫—Å—Ç—É:\n\n${text}`,
        },
      ],
      temperature: 0.2,
    });

    const summary = JSON.parse(completion.choices[0].message.content);
    res.status(200).json({ summary });
  } catch (error) {
    console.error("OpenAI error:", error);
    res.status(500).json({ error: "Failed to create summary" });
  }
}
